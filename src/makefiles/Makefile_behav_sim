TESTBENCH=tb_matmul
# TESTNAME=single
TESTNAME=multi
NUM_TESTS=100

SRC_VERILOG=../../src/rtl
SRC_VERIF=../../src/verif
RTL_FOLDER=$(SRC_VERILOG)
TB_FOLDER=$(SRC_VERIF)/testbench
SYNOPSYS=/tools/software/synopsys

DEBUG=1
VCS=1

# Test vars
M=3
K=3
N=3
LOW=-16
HIGH=16
VERBOSE=1

PYTHON=python3.8

#Build up a list of verilog define statements to be used by vcs
VERILOG_DEFINES:= 
ifeq ($(DEBUG), 1)
		VERILOG_DEFINES := $(VERILOG_DEFINES)+DEBUG=1
endif
ifeq ($(VCS), 1)
		VERILOG_DEFINES := $(VERILOG_DEFINES)+VCS=1
endif

.DEFAULT_GOAL := vcs

# Move all the verilog files from the source directory over to this simulation directory
link_src:
	ln -s $(RTL_FOLDER) .
	ln -s $(TB_FOLDER) .
	ln -s $(SRC_VERIF)/scripts .
	ln -s $(SRC_VERIF)/include/$(TESTBENCH).include .

mem:
	rm -rf bin
	mkdir bin
	$(PYTHON) scripts/data_gen.py -d $(M) $(K) $(N) -b $(LOW) $(HIGH) -n $(NUM_TESTS)

verif:
	$(PYTHON) scripts/verify.py -d $(M) $(K) $(N) -n $(NUM_TESTS)

# A new option has been added here. Take a closer look at -cm. Look it up!
vcs:$(TESTBENCH).include
	vcs -f $(TESTBENCH).include +v2k -R -sverilog -full64 \
		-timescale=1ns/10ps -debug_access+all -debug_region+cell+encrypt \
		-debug_access -l $(TESTBENCH).log +define+$(VERILOG_DEFINES) \
		+testname=$(TESTNAME) +numtests=$(NUM_TESTS) \
		+incdir+$(SYNOPSYS)/syn/latest/dw/sim_ver \
		-cm fsm+line+assert \
		-lca -kdb \
		+lint=all

run: mem vcs verif

wipe: clean
	rm -rf *.include
	rm -rf alib-52
	rm -rf simv.daidir
	rm -rf DVEfiles
	rm -rf *.log
	rm -rf *.vpd
	rm -rf ucli.key
	rm -rf default.svf
	rm -rf simv
	rm -rf *.sv *.v *.svh
	rm -rf csrc
	rm -rf novas*
	rm -rf verdi_config_file
	rm -rf verdiLog
	rm -rf *.fsdb
	rm -rf rtl
	rm -rf scripts
	rm -rf testbench

clean:
	rm -rf DVEfiles
	rm -rf *.log
	rm -rf *.vpd
	rm -rf ucli.key
	rm -rf alib-52
	rm -rf $(TESTBENCH)
	rm -rf simv.daidir
	rm -rf csrc
	rm -rf simv
	rm -rf novas*
	rm -rf verdi_config_file
	rm -rf verdiLog
	rm -rf *.fsdb
	rm -rf *.vdb
	rm -rf vdCovLog
	rm -rf .fsm.sch.verilog.xml
	rm -rf vdCov.conf
	rm -rf dut_log/*